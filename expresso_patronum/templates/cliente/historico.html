{% extends 'base.html' %}
{% load static %}

{% block title %}Histórico de Pedidos - Expresso Patronum{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/auth.css' %}">
<link rel="stylesheet" href="{% static 'css/cliente-historico.css' %}">
{% endblock %}

{% block content %}
<div class="historico-container">
    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {% if not error %}
        <div class="historico-header">
            <h1 class="historico-title">
                <i class="fas fa-history"></i> Histórico de Pedidos
            </h1>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value">{{ estatisticas.total }}</div>
                    <div class="stat-label">Total de Pedidos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ estatisticas.concluidos }}</div>
                    <div class="stat-label">Pedidos Entregues</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{{ estatisticas.pendentes }}</div>
                    <div class="stat-label">Pedidos Pendentes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">R$ {{ estatisticas.valor_total|floatformat:2 }}</div>
                    <div class="stat-label">Total Gasto</div>
                </div>
            </div>
        </div>

        <div class="historico-content">
            <!-- Filtros -->
            <div class="filters-section">
                <form method="GET" class="filters-row">
                    <div class="filter-group">
                        <label class="filter-label">Status:</label>
                        <select name="status" class="filter-input">
                            <option value="">Todos os status</option>
                            {% for value, label in status_choices %}
                                <option value="{{ value }}" {% if filtro_status == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">Mês:</label>
                        <input type="month" name="mes" class="filter-input" value="{{ filtro_mes }}">
                    </div>
                    
                    <div class="filter-group">
                        <label class="filter-label">&nbsp;</label>
                        <button type="submit" class="filter-button">
                            <i class="fas fa-search"></i> Filtrar
                        </button>
                    </div>
                    
                    {% if filtro_status or filtro_mes %}
                        <div class="filter-group">
                            <label class="filter-label">&nbsp;</label>
                            <a href="{% url 'cliente:historico' %}" class="filter-button" style="background: #6c757d; text-decoration: none;">
                                <i class="fas fa-times"></i> Limpar
                            </a>
                        </div>
                    {% endif %}
                </form>
            </div>

            <!-- Lista de Pedidos -->
            {% if pedidos %}
                <div class="pedidos-list">
                    {% for pedido in pedidos %}
                        <div class="pedido-item">
                            <div class="pedido-header">
                                <div>
                                    <div class="pedido-numero">Pedido #{{ pedido.id }}</div>
                                    <div class="pedido-data">
                                        {{ pedido.criado_em|date:"d/m/Y H:i" }}
                                    </div>
                                </div>
                                <div class="pedido-status status-{{ pedido.status|lower|slugify }}">
                                    {{ pedido.status }}
                                </div>
                            </div>
                            
                            <div class="pedido-details">
                                <div class="itens-list">
                                    <strong>Itens:</strong><br>
                                    {% if pedido.itens_formatados %}
                                        {{ pedido.itens_formatados|linebreaks }}
                                    {% else %}
                                        Cliente: {{ pedido.cliente }}<br>
                                        Bebida: {{ pedido.bebida }}<br>
                                        {% if pedido.observacoes %}
                                            Observações: {{ pedido.observacoes }}
                                        {% endif %}
                                    {% endif %}
                                </div>
                                
                                <div class="pedido-valor">
                                    <div class="valor-total">R$ {{ pedido.preco|floatformat:2 }}</div>
                                    <div class="valor-label">Total</div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-state">
                    <i class="fas fa-receipt empty-icon"></i>
                    <h3>Nenhum pedido encontrado</h3>
                    {% if filtro_status or filtro_mes %}
                        <p>Não encontramos pedidos com os filtros aplicados.</p>
                        <a href="{% url 'cliente:historico' %}" class="btn-action">
                            <i class="fas fa-times"></i> Limpar Filtros
                        </a>
                    {% else %}
                        <p>Você ainda não fez nenhum pedido. Que tal experimentar nossos cafés mágicos?</p>
                        <a href="{% url 'menu:cardapio' %}" class="btn-action">
                            <i class="fas fa-coffee"></i> Ver Cardápio
                        </a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    {% else %}
        <div class="historico-content">
            <div class="empty-state">
                <i class="fas fa-exclamation-triangle" style="color: #e74c3c; font-size: 4rem; margin-bottom: 1rem;"></i>
                <h3>Erro ao carregar histórico</h3>
                <p>Ocorreu um erro ao carregar seus pedidos. Tente recarregar a página.</p>
                <a href="{% url 'cliente:historico' %}" class="btn-action">
                    <i class="fas fa-refresh"></i> Recarregar
                </a>
            </div>
        </div>
    {% endif %}
</div>

<script>
// Animação para as estatísticas
document.addEventListener('DOMContentLoaded', function() {
    const statValues = document.querySelectorAll('.stat-value');
    
    statValues.forEach(stat => {
        const text = stat.textContent.trim();
        const number = parseFloat(text.replace('R$', '').replace(',', '.')) || parseInt(text) || 0;
        
        if (number > 0) {
            let currentValue = 0;
            const increment = number / 50;
            const timer = setInterval(() => {
                currentValue += increment;
                if (currentValue >= number) {
                    if (text.includes('R$')) {
                        stat.textContent = `R$ ${number.toFixed(2)}`;
                    } else {
                        stat.textContent = Math.floor(number);
                    }
                    clearInterval(timer);
                } else {
                    if (text.includes('R$')) {
                        stat.textContent = `R$ ${currentValue.toFixed(2)}`;
                    } else {
                        stat.textContent = Math.floor(currentValue);
                    }
                }
            }, 30);
        }
    });
});
</script>
{% endblock %}
