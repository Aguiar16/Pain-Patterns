{% extends 'base.html' %}

{% block title %}Meus Pedidos - Expresso Patronum{% endblock %}

{% block content %}
<div class="row">

<div class="row">
    {% for pedido in pedidos_ativos %}
    <div class="col-md-6 mb-4">
        <div class="magical-card" data-order-id="{{ pedido.id }}">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 style="color: #8B0000;">Pedido #{{ pedido.id }}</h5>
                <span class="status-badge status-{{ pedido.status|lower }}">{{ pedido.status }}</span>
            </div>
            <div class="order-details">
                <h6 style="color: #3C2415;">{{ pedido.bebida }}</h6>
                {% if pedido.ingredientes %}
                <ul style="list-style: none; padding-left: 0; font-size: 0.9rem; color: #666;">
                    {% for ing in pedido.ingredientes %}
                        <li>‚Ä¢ {{ ing }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
                <div class="row mt-3">
                    <div class="col-6">
                        <strong style="color: #D4AF37;">Total: R$ {{ pedido.preco|floatformat:2 }}</strong>
                    </div>
                    <div class="col-6 text-end">
                        <small style="color: #666;">Pedido √†s {{ pedido.horario }}</small>
                    </div>
                </div>
            </div>
            <div class="progress-bar-container mt-3">
                <div class="progress" style="height: 8px; background: #E8E0D1;">
                    <div class="progress-bar" style="width: {{ pedido.progresso }}%; background: linear-gradient(90deg, #0E1A40, #1E3A8A); transition: width 0.5s ease;"></div>
                </div>
                <div class="d-flex justify-content-between mt-2" style="font-size: 0.8rem;">
                    <span style="color: #FFD700;">‚úì Recebido</span>
                    <span style="color: #0E1A40;">{% if pedido.status == 'Em preparo' %}üßô‚Äç‚ôÇÔ∏è Em Preparo{% elif pedido.status == 'Recebido' %}Em Preparo{% else %}‚úì Em Preparo{% endif %}</span>
                    <span style="color: #2D5016;">{% if pedido.status == 'Pronto' %}üéâ Pronto{% else %}Pronto{% endif %}</span>
                    <span style="color: #ccc;">Entregue</span>
                </div>
            </div>
            <div class="text-center mt-3">
                <button class="magical-btn" onclick="trackOrder('{{ pedido.id }}')">
                    üîç Rastrear Po√ß√£o
                </button>
                <div class="mt-2">
                    <button class="magical-btn" style="background: #DAA520; font-size: 0.9rem; padding: 0.5rem 1rem;" onclick="alterarPedido('{{ pedido.id }}')">
                        ‚úèÔ∏è Alterar
                    </button>
                    <button class="magical-btn danger" style="font-size: 0.9rem; padding: 0.5rem 1rem; margin-left: 0.5rem;" onclick="cancelarPedido('{{ pedido.id }}')">
                        ‚ùå Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="col-12 text-center">
        <p style="color: #666; font-size: 1.1rem;">Nenhum pedido em andamento.</p>
    </div>
    {% endfor %}
</div>
            </div>
        </div>
    </div>
</div>

<!-- Hist√≥rico de Pedidos -->
<div class="row mt-5">
    <div class="col-12">
        <h3 style="font-family: 'Cinzel', serif; color: #3C2415; margin-bottom: 1.5rem;">
            üìö Hist√≥rico de Po√ß√µes
        </h3>
    </div>
</div>


<div class="row">
    <div class="col-12">
        <div class="magical-card">
            <div class="table-responsive">
                <table class="table table-borderless">
                    <thead>
                        <tr style="border-bottom: 2px solid #D4AF37;">
                            <th style="color: #3C2415;">Pedido</th>
                            <th style="color: #3C2415;">Po√ß√£o</th>
                            <th style="color: #3C2415;">Data</th>
                            <th style="color: #3C2415;">Total</th>
                            <th style="color: #3C2415;">Status</th>
                            <th style="color: #3C2415;">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pedido in historico %}
                        <tr>
                            <td><strong>#{{ pedido.id }}</strong></td>
                            <td>{{ pedido.bebida }}</td>
                            <td>{{ pedido.data }}</td>
                            <td style="color: #D4AF37;"><strong>R$ {{ pedido.preco|floatformat:2 }}</strong></td>
                            <td><span class="status-badge status-entregue">{{ pedido.status }}</span></td>
                            <td>
                                <button class="btn btn-sm magical-btn" onclick="reorderItem('{{ pedido.id }}')">
                                    üîÑ Repetir
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center" style="color: #666;">Nenhum pedido hist√≥rico encontrado.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- √Årea de Finaliza√ß√£o -->
<div class="row mt-4">
    <div class="col-12">
        <div class="magical-card text-center" style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(139, 0, 0, 0.1));">
            <h4 style="font-family: 'Cinzel', serif; color: #8B0000;">
                üõí Pronto para Finalizar Seu Pedido?
            </h4>
            <p style="color: #3C2415; margin: 1rem 0;">
                Escolha suas po√ß√µes e finalize com os melhores descontos m√°gicos!
            </p>
            <div class="d-flex justify-content-center gap-3 flex-wrap">
                <a href="{% url 'menu:cardapio' %}" class="magical-btn">
                    üìú Adicionar Mais Po√ß√µes
                </a>
                <a href="{% url 'pedido:pagamento' %}" class="magical-btn success">
                    üí∞ Finalizar Pedido
                </a>
                <button class="magical-btn" style="background: #DAA520;" onclick="mostrarHistorico()">
                    üìú Ver Hist√≥rico de Comandos
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Rastreamento -->
<div class="modal fade" id="tracking-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: #F4F1E8; border: 2px solid #D4AF37;">
            <div class="modal-header" style="border-color: #D4AF37;">
                <h5 class="modal-title" style="font-family: 'Cinzel', serif; color: #8B0000;">
                    üîÆ Rastreamento da Po√ß√£o
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <h6 id="tracking-order-name">üç∫ Butterbeer Latte Personalizado</h6>
                    <p style="color: #666;">Pedido #<span id="tracking-order-id">001</span></p>
                </div>
                
                <div class="tracking-timeline mt-4">
                    <div class="timeline-item completed">
                        <div class="timeline-marker">‚úì</div>
                        <div class="timeline-content">
                            <h6>Pedido Recebido</h6>
                            <p>Sua po√ß√£o foi registrada em nosso grim√≥rio</p>
                            <small>14:25</small>
                        </div>
                    </div>
                    <div class="timeline-item active">
                        <div class="timeline-marker">üßô‚Äç‚ôÇÔ∏è</div>
                        <div class="timeline-content">
                            <h6>Em Preparo na Cozinha M√°gica</h6>
                            <p>Nossos baristas est√£o preparando sua po√ß√£o com muito carinho</p>
                            <small>14:27</small>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-marker">üéâ</div>
                        <div class="timeline-content">
                            <h6>Po√ß√£o Pronta</h6>
                            <p>Sua bebida estar√° pronta para retirada</p>
                            <small>Em breve...</small>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-marker">‚ú®</div>
                        <div class="timeline-content">
                            <h6>Entregue</h6>
                            <p>Aproveite sua po√ß√£o m√°gica!</p>
                            <small>Aguardando...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Alterar Pedido (Command Pattern) -->
<div class="modal fade" id="alterar-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background: #F4F1E8; border: 2px solid #D4AF37;">
            <div class="modal-header" style="border-color: #D4AF37;">
                <h5 class="modal-title" style="font-family: 'Cinzel', serif; color: #8B0000;">
                    ‚úèÔ∏è Alterar Pedido M√°gico
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="alterar-form">
                    <div class="mb-3">
                        <label class="form-label" style="color: #3C2415; font-weight: bold;">üßô‚Äç‚ôÇÔ∏è Nome do Bruxo/Bruxa:</label>
                        <input type="text" class="form-control" id="novo-cliente" placeholder="Novo nome...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label" style="color: #3C2415; font-weight: bold;">üìù Novas Instru√ß√µes Especiais:</label>
                        <textarea class="form-control" id="novas-observacoes" rows="3" 
                                  placeholder="Ex: 'Mais doce', 'Extra quente', 'Sem a√ß√∫car'..."></textarea>
                    </div>
                    <div class="alert" style="background: rgba(212, 175, 55, 0.1); border: 1px solid #D4AF37; color: #8B0000;">
                        <small>
                            <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Pedidos em preparo n√£o podem ser alterados. 
                            Apenas pedidos "Recebidos" permitem altera√ß√µes.
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="border-color: #D4AF37;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="magical-btn" onclick="confirmarAlteracao()">
                    ‚ú® Alterar Pedido
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Cancelar Pedido (Command Pattern) -->
<div class="modal fade" id="cancelar-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background: #F4F1E8; border: 2px solid #DC3545;">
            <div class="modal-header" style="border-color: #DC3545;">
                <h5 class="modal-title" style="font-family: 'Cinzel', serif; color: #DC3545;">
                    ‚ùå Cancelar Pedido M√°gico
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <div style="font-size: 3rem;">üò¢</div>
                    <h6 style="color: #8B0000;">Tem certeza que deseja cancelar este pedido?</h6>
                </div>
                <form id="cancelar-form">
                    <div class="mb-3">
                        <label class="form-label" style="color: #3C2415; font-weight: bold;">üí≠ Motivo do cancelamento (opcional):</label>
                        <select class="form-control" id="motivo-cancelamento">
                            <option value="Mudei de ideia">Mudei de ideia</option>
                            <option value="Demora no preparo">Demora no preparo</option>
                            <option value="Problema financeiro">Problema financeiro</option>
                            <option value="Outro">Outro motivo</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <textarea class="form-control" id="motivo-detalhado" rows="2" 
                                  placeholder="Detalhes adicionais (opcional)..."></textarea>
                    </div>
                    <div class="alert alert-warning">
                        <small>
                            <strong>‚ÑπÔ∏è Importante:</strong> O cancelamento pode ser desfeito usando o hist√≥rico de comandos. 
                            Pedidos j√° entregues n√£o podem ser cancelados.
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="border-color: #DC3545;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Voltar</button>
                <button type="button" class="btn btn-danger" onclick="confirmarCancelamento()">
                    üíî Sim, Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Hist√≥rico de Comandos -->
<div class="modal fade" id="historico-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: #F4F1E8; border: 2px solid #D4AF37;">
            <div class="modal-header" style="border-color: #D4AF37;">
                <h5 class="modal-title" style="font-family: 'Cinzel', serif; color: #8B0000;">
                    üìú Hist√≥rico de Comandos M√°gicos
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-center mb-3">
                    <button class="magical-btn" onclick="desfazerComando()" style="margin-right: 0.5rem;">
                        ‚Ü©Ô∏è Desfazer
                    </button>
                    <button class="magical-btn" onclick="refazerComando()">
                        ‚Ü™Ô∏è Refazer
                    </button>
                </div>
                <div id="historico-lista" style="max-height: 300px; overflow-y: auto;">
                    <!-- Lista ser√° preenchida via JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
.tracking-timeline {
    position: relative;
    padding-left: 2rem;
}

.tracking-timeline::before {
    content: '';
    position: absolute;
    left: 1rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #D4AF37;
}

.timeline-item {
    position: relative;
    margin-bottom: 2rem;
    padding-left: 2rem;
}

.timeline-marker {
    position: absolute;
    left: -2.5rem;
    width: 2rem;
    height: 2rem;
    background: #F4F1E8;
    border: 2px solid #D4AF37;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
}

.timeline-item.completed .timeline-marker {
    background: #2D5016;
    color: white;
    border-color: #2D5016;
}

.timeline-item.active .timeline-marker {
    background: #0E1A40;
    color: white;
    border-color: #0E1A40;
    animation: pulse 2s infinite;
}

.timeline-content h6 {
    color: #3C2415;
    margin-bottom: 0.5rem;
}

.timeline-content p {
    color: #666;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.timeline-content small {
    color: #999;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function trackOrder(orderId) {
    document.getElementById('tracking-order-id').textContent = orderId;
    const modal = new bootstrap.Modal(document.getElementById('tracking-modal'));
    modal.show();
    
    showMagicalNotification('Rastreando sua po√ß√£o m√°gica! üîÆ', 'info');
}

function confirmPickup(orderId) {
    showMagicalNotification('Po√ß√£o retirada com sucesso! Aproveite! ‚ú®', 'success');
    
    // Atualiza o status visual
    const orderCard = document.querySelector(`[data-order-id="${orderId}"]`);
    const statusBadge = orderCard.querySelector('.status-badge');
    statusBadge.className = 'status-badge status-entregue';
    statusBadge.textContent = 'Entregue';
    
    // Atualiza a barra de progresso
    const progressBar = orderCard.querySelector('.progress-bar');
    progressBar.style.width = '100%';
    progressBar.style.background = 'linear-gradient(90deg, #8B0000, #E74C3C)';
    
    // Remove o card ap√≥s alguns segundos
    setTimeout(() => {
        orderCard.style.opacity = '0';
        orderCard.style.transform = 'translateY(-20px)';
        setTimeout(() => orderCard.remove(), 500);
    }, 3000);
}

function reorderItem(orderId) {
    showMagicalNotification('Preparando a mesma po√ß√£o deliciosa! üßô‚Äç‚ôÇÔ∏è', 'success');
    // Aqui seria feita a l√≥gica para repetir o pedido
}

function alterarPedido(orderId) {
    // Preencher dados atuais do pedido no modal
    document.getElementById('novo-cliente').value = ''; // Limpar para permitir novo nome
    document.getElementById('novas-observacoes').value = ''; // Limpar para novas observa√ß√µes
    
    // Armazenar ID do pedido para uso posterior
    window.currentPedidoId = orderId;
    
    const modal = new bootstrap.Modal(document.getElementById('alterar-modal'));
    modal.show();
}

function cancelarPedido(orderId) {
    // Armazenar ID do pedido para cancelamento
    window.currentPedidoId = orderId;
    
    const modal = new bootstrap.Modal(document.getElementById('cancelar-modal'));
    modal.show();
}

function confirmarAlteracao() {
    const novoCliente = document.getElementById('novo-cliente').value;
    const novasObservacoes = document.getElementById('novas-observacoes').value;
    
    if (!novoCliente && !novasObservacoes) {
        showMagicalNotification('Por favor, preencha pelo menos um campo para alterar! üìù', 'warning');
        return;
    }
    
    // Fazer chamada para API de altera√ß√£o
    const formData = new FormData();
    if (novoCliente) formData.append('novo_cliente', novoCliente);
    if (novasObservacoes) formData.append('novas_observacoes', novasObservacoes);
    
    fetch(`/pedido/api/alterar-pedido/${window.currentPedidoId}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMagicalNotification(data.message, 'success');
            
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('alterar-modal'));
            modal.hide();
            
            // Recarregar p√°gina para mostrar altera√ß√µes
            setTimeout(() => location.reload(), 1500);
        } else {
            showMagicalNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMagicalNotification('Erro ao alterar pedido! Tente novamente.', 'error');
    });
}

function confirmarCancelamento() {
    const motivo = document.getElementById('motivo-cancelamento').value;
    const motivoDetalhado = document.getElementById('motivo-detalhado').value;
    
    let motivoCompleto = motivo;
    if (motivoDetalhado) {
        motivoCompleto += ` - ${motivoDetalhado}`;
    }
    
    // Fazer chamada para API de cancelamento
    const formData = new FormData();
    formData.append('motivo', motivoCompleto);
    
    fetch(`/pedido/api/cancelar-pedido/${window.currentPedidoId}/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMagicalNotification(data.message, 'success');
            
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('cancelar-modal'));
            modal.hide();
            
            // Atualizar visualmente o pedido
            const orderCard = document.querySelector(`[data-order-id="${window.currentPedidoId}"]`);
            if (orderCard) {
                const statusBadge = orderCard.querySelector('.status-badge');
                if (statusBadge) {
                    statusBadge.className = 'status-badge';
                    statusBadge.style.background = '#dc3545';
                    statusBadge.style.color = 'white';
                    statusBadge.textContent = 'Cancelado';
                }
                
                // Adicionar visual de cancelado
                orderCard.style.opacity = '0.7';
                orderCard.style.borderColor = '#dc3545';
            }
            
            // Recarregar p√°gina ap√≥s 2 segundos
            setTimeout(() => location.reload(), 2000);
        } else {
            showMagicalNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMagicalNotification('Erro ao cancelar pedido! Tente novamente.', 'error');
    });
}

function desfazerComando() {
    fetch('/pedido/api/desfazer/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMagicalNotification(`‚Ü©Ô∏è ${data.message}`, 'success');
            atualizarHistorico();
            
            // Recarregar p√°gina para mostrar mudan√ßas
            setTimeout(() => location.reload(), 1500);
        } else {
            showMagicalNotification(data.message, 'warning');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMagicalNotification('Erro ao desfazer comando!', 'error');
    });
}

function refazerComando() {
    fetch('/pedido/api/refazer/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMagicalNotification(`‚Ü™Ô∏è ${data.message}`, 'success');
            atualizarHistorico();
            
            // Recarregar p√°gina para mostrar mudan√ßas
            setTimeout(() => location.reload(), 1500);
        } else {
            showMagicalNotification(data.message, 'warning');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMagicalNotification('Erro ao refazer comando!', 'error');
    });
}

function atualizarHistorico() {
    fetch('/pedido/api/historico/')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const lista = document.getElementById('historico-lista');
            lista.innerHTML = '';
            
            if (data.historico.length === 0) {
                lista.innerHTML = '<p class="text-center" style="color: #666;">Nenhum comando executado ainda</p>';
                return;
            }
            
            data.historico.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'p-2 mb-2 rounded';
                div.style.background = item.executado ? 'rgba(45, 80, 22, 0.1)' : 'rgba(220, 53, 69, 0.1)';
                div.style.border = `1px solid ${item.executado ? '#2D5016' : '#dc3545'}`;
                
                const status = item.executado ? '‚úÖ Executado' : '‚ùå Desfeito';
                const icon = getCommandIcon(item.tipo);
                
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <span><strong>${index + 1}. ${icon} ${item.tipo}</strong></span>
                        <span style="font-size: 0.9rem;">${status}</span>
                    </div>
                `;
                
                lista.appendChild(div);
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function getCommandIcon(commandType) {
    const icons = {
        'FazerPedidoCommand': 'üÜï',
        'AlterarPedidoCommand': '‚úèÔ∏è',
        'CancelarPedidoCommand': '‚ùå'
    };
    return icons[commandType] || '‚ö°';
}

function mostrarHistorico() {
    atualizarHistorico();
    const modal = new bootstrap.Modal(document.getElementById('historico-modal'));
    modal.show();
}

// Simula√ß√£o de atualiza√ß√µes em tempo real
setInterval(() => {
    const activeOrders = document.querySelectorAll('.status-preparo, .status-recebido');
    activeOrders.forEach(badge => {
        badge.style.animation = 'pulse 0.5s ease-in-out';
        setTimeout(() => {
            badge.style.animation = '';
        }, 500);
    });
}, 15000);

document.addEventListener('DOMContentLoaded', function() {
    // Anima√ß√£o inicial dos pedidos
    const orderCards = document.querySelectorAll('.magical-card');
    orderCards.forEach((card, index) => {
        setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 200);
        
        card.style.opacity = '0';
        card.style.transform = 'translateY(30px)';
        card.style.transition = 'all 0.6s ease';
    });
});
</script>
{% endblock %}
